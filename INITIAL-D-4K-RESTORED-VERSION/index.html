<!DOCTYPE html>
<html lang="zh-Hant" style="scroll-behavior: smooth;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    html, body {
      max-width: 100%;
      overflow-x: clip;
    }
    body { font-family: 'Inter', sans-serif; }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #93B881;
      animation: spin 1s ease infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
  </style>
  <title>《頭文字D（4K修復版）》特典回報</title>
  <!-- Favicon -->
  <link rel="icon" href="../twtokuten.png" type="image/png">
</head>
<body class="bg-[#f5f9f3] text-[#2d4a24]">

  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-2xl">
    <!-- 標題與圖片區塊 -->
    <div class="bg-[#fcfdf8] rounded-2xl shadow-lg mb-4">
      <div class="p-4 sm:p-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-[#585048]">《頭文字D（4K修復版）》特典回報</h1>
        <hr class="my-4 border-[#d4e7cc]">
        <div class="flex flex-col sm:flex-row gap-2 my-4">
          <!-- 主要動作按鈕 -->
          <a href="https://forms.fillout.com/t/4WQfvXuKeBus" target="_blank" rel="noopener noreferrer" class="w-full sm:flex-1 p-1.5 bg-[#93B881] text-white text-sm text-center font-medium rounded-lg hover:bg-[#7da56d] transition-colors duration-200 shadow-sm">我要回報現況</a>
          <!-- 次要動作按鈕 -->
          <div class="flex gap-2 sm:contents">
            <a href="https://www.threads.com/@pdatone" target="_blank" rel="noopener noreferrer" class="flex-1 p-1.5 bg-[#e8f2e3] text-[#446635] text-sm text-center font-medium rounded-lg hover:bg-[#d4e7cc] transition-colors duration-200 shadow-sm">私訊作者</a>
            <a href="https://pdatone.github.io/tw-movie-tokuten/" class="flex-1 p-1.5 bg-[#F4F7F3] text-[#527a42] text-sm text-center font-medium rounded-lg hover:bg-[#e8f2e3] transition-colors duration-200 shadow-sm">返回總覽</a>
          </div>
        </div>
        <p class="text-base text-[#585048] mt-2">上映日期：2025/10/23 (四)</p>
        <p class="text-base text-[#585048] mt-2"><a href="https://www.facebook.com/lsmovie/posts/pfbid0HWfDcRY9fAmDW38zgxQisXPPWHTWg1YEkG9pFTvkevMjVsAr8KqGobg9ynGxfpLTl" target="_blank" rel="noopener noreferrer" class="text-[#4A6C3A] font-medium hover:underline">官方海報資訊請點此處查看</a></p>
        <p class="text-xs text-[#585048] mt-2">本頁面使用 AI 製作，若有需要新增沒出現在列表上的電影，或是頁面錯誤等其他問題，請私訊我的 Threads。因為目前 Readme 還沒編輯完成，如果你也想要使用這個工具，歡迎私訊跟我聯繫，我會跟你說怎麼使用～</p>
        <p class="text-sm text-[#527a42] mt-2">
          <span>回報資料最後更新時間：</span><span id="last-update-time">讀取中……</span>
        </p>
        <img src="https://images.plurk.com/2F9HXTDymrAKigxcQ8OFGG.jpg" alt="特典活動圖片" class="block w-full mt-4 rounded-lg object-cover">
      </div>
    </div>

    <!-- 控制區塊（吸頂效果） -->
    <div id="controls-container" class="sticky p-4 sm:p-6 top-0 z-50 bg-[#fcfdf8] rounded-2xl shadow-lg mb-4">
      <label for="week-selector" class="block font-medium text-[#585048]">請選擇您想查詢的特典週次。</label>
      <div id="week-loading" class="mt-2 text-sm text-[#527a42]">正在載入週次選項……</div>
      <select id="week-selector" class="hidden mt-1 block w-full pl-3 pr-10 py-2 text-sm text-[#2d4a24] bg-[#fcfdf8] border-[#d4e7cc] focus:outline-none focus:ring-[#93B881] focus:border-[#93B881] sm:text-sm rounded-md shadow-sm">
        <option value="">— 請選擇 —</option>
      </select>
      <div id="region-anchor-nav" class="hidden mt-4 pb-0 sm:px-0 flex-wrap gap-2 justify-start flex"></div>
    </div>

    <!-- 結果顯示區域 -->
    <div id="results-wrapper" class="hidden bg-[#fcfdf8] rounded-2xl shadow-lg">
      <div id="results-container" class="p-4 sm:p-6">
        <div id="loading-spinner" class="hidden justify-center items-center py-10">
          <div class="spinner"></div>
          <p class="ml-4 text-[#527a42]">正在載入資料……</p>
        </div>
        <div id="error-message" class="hidden text-center text-red-600 bg-red-50 p-4 rounded-lg"></div>
        <div id="data-display-area"></div>
      </div>
    </div>
  </div>

<script>
  // DOM元素的全域變數
  let weekSelector, resultsContainer, loadingSpinner, errorMessage, dataDisplayArea, weekLoadingMsg, regionAnchorNav;

  // Google Apps Script Web App URL
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxZ5NZzIf_JgI6sqKR5ycL54gKfjCKJ4p1C4_dFMcxUOQbFVvSYDFv7hxH1Co_soScN/exec';

  /**
   * 向 GAS 後端發送請求的通用函式
   */
  async function callGAS(action, params = {}) {
    try {
      const url = new URL(GAS_URL);
      url.searchParams.append('action', action);
      Object.keys(params).forEach(key => {
        url.searchParams.append(key, params[key]);
      });
      
      const response = await fetch(url.toString());
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      return data;
    } catch (error) {
      console.error('GAS 請求錯誤:', error);
      throw error;
    }
  }

  /**
   * 當頁面 DOM 載入完成後執行的主要函式
   */
  document.addEventListener('DOMContentLoaded', async () => {
    // 初始化DOM元素變數
    weekSelector = document.getElementById('week-selector');
    resultsContainer = document.getElementById('results-container');
    loadingSpinner = document.getElementById('loading-spinner');
    errorMessage = document.getElementById('error-message');
    dataDisplayArea = document.getElementById('data-display-area');
    weekLoadingMsg = document.getElementById('week-loading');
    regionAnchorNav = document.getElementById('region-anchor-nav');

    // 1. 綁定下拉選單的變動事件
    weekSelector.addEventListener('change', handleWeekChange);

    // 2. 向後端請求可用的週次列表
    try {
      showElement('week-loading'); // 確保初始載入提示可見
      const weeks = await callGAS('getAvailableWeeks');
      populateWeekSelector(weeks);
    } catch (error) {
      showError(error);
    }

    // [新增] 3. 向後端請求最後更新時間
    try {
      const timeString = await callGAS('getLastUpdateTime');
      displayLastUpdateTime(timeString);
    } catch (error) {
      console.error('取得更新時間失敗:', error);
      displayLastUpdateTime(null); // 顯示錯誤訊息
    }
  });

  /**
   * [新增] 顯示最後更新時間
   * @param {string} timeString - 後端回傳的格式化時間字串
   */
  function displayLastUpdateTime(timeString) {
    const el = document.getElementById('last-update-time');
    if (el) {
      if (timeString) {
        el.textContent = timeString;
      } else {
        el.textContent = '尚未收到特典回報資料。';
      }
    }
  }

  /**
   * 將後端回傳的週次列表填入下拉選單
   */
  function populateWeekSelector(weeks) {
    hideElement('week-loading');
    if (weeks && weeks.length > 0) {
      weeks.forEach(week => {
        const option = document.createElement('option');
        option.value = week;
        option.textContent = week;
        weekSelector.appendChild(option);
      });
      showElement('week-selector');
    } else {
      weekLoadingMsg.textContent = '目前沒有收到任何特典週次的回報資料。';
      showElement('week-loading');
    }
  }

  /**
   * 當使用者在下拉選單選擇新的週次時觸發
   */
  async function handleWeekChange() {
    const selectedWeek = weekSelector.value;
    
    dataDisplayArea.innerHTML = '';
    regionAnchorNav.innerHTML = '';
    hideElement('error-message');
    hideElement('region-anchor-nav');

    if (!selectedWeek) {
      hideElement('results-wrapper');
      return;
    }
    
    // 顯示結果區域並顯示載入中的旋轉圖示
    showElement('results-wrapper');
    showElement('loading-spinner', 'flex');

    try {
      const allData = await callGAS('getDataForWeek', { week: selectedWeek });
      displayAllResults(allData);
    } catch (error) {
      showError(error);
    }
  }

  /**
   * 將所有地區的資料動態生成為 HTML 內容並顯示
   */
  function displayAllResults(allData) {
    hideElement('loading-spinner');
    
    if (allData.error) {
      showError({ message: allData.error });
      return;
    }
    
    if (!allData || allData.length === 0) {
      dataDisplayArea.innerHTML = `<div class="text-center text-[#527a42] py-10"><p>此週次尚無任何回報資料。</p></div>`;
      return;
    }

    let finalHTML = '';
    allData.forEach(regionData => {
      const anchor = document.createElement('a');
      anchor.href = `#region-${regionData.region}`;
      anchor.textContent = regionData.region;
      anchor.className = 'px-3 py-1.5 text-xs font-medium text-[#446635] bg-[#e8f2e3] rounded-xl hover:bg-[#d4e7cc] hover:text-[#2d4a24] transition-colors duration-200';
      regionAnchorNav.appendChild(anchor);

      finalHTML += `<div id="region-${regionData.region}" class="mt-6 sm:mt-8 first:mt-0 scroll-mt-48"><h2 class="text-lg sm:text-xl font-bold text-[#2d4a24] bg-[#e8f2e3] px-3 py-2 sm:px-4 rounded-t-xl">${regionData.region}</h2><div class="overflow-x-auto border border-[#d4e7cc] rounded-b-xl"><table class="w-full table-fixed divide-y divide-[#d4e7cc]"><thead class="bg-[#f5f9f3]"><tr><th scope="col" class="w-2/3 px-3 sm:px-4 py-1 text-left text-xs font-medium text-[#475447] uppercase tracking-wider">影城名稱</th><th scope="col" class="w-1/3 px-3 sm:px-4 py-1 text-left text-xs font-medium text-[#475447] uppercase tracking-wider">特典狀態</th></tr></thead><tbody class="bg-[#fcfdf8] divide-y divide-[#d4e7cc]">`;
      if (regionData.cinemas && regionData.cinemas.length > 0) {
        regionData.cinemas.forEach(item => {
          finalHTML += `<tr class="hover:bg-[#f5f9f3] transition-colors duration-200"><td class="w-2/3 px-3 sm:px-4 py-2 text-sm font-medium text-[#585048] break-words">${item.theater}</td><td class="w-1/3 px-3 sm:px-4 py-2 whitespace-nowrap text-sm text-[#585048]">${item.status}</td></tr>`;
        });
      } else {
        finalHTML += `<tr><td colspan="2" class="px-6 py-4 text-center text-sm text-[#585048]">此地區尚無影城資料。</td></tr>`;
      }
      finalHTML += `</tbody></table></div></div>`;
    });
    dataDisplayArea.innerHTML = finalHTML;
    showElement('region-anchor-nav', 'flex');
  }

  /**
   * 顯示錯誤訊息
   */
  function showError(error) {
    hideElement('loading-spinner');
    hideElement('week-loading');
    hideElement('region-anchor-nav');
    errorMessage.textContent = `發生錯誤：${error.message}，請確認試算表設定是否正確或稍後再試。`;
    showElement('error-message');
    showElement('results-wrapper');
  }

  // --- Helper Functions ---
  function showElement(id, displayType = 'block') {
    const el = document.getElementById(id);
    if (el) el.classList.remove('hidden');
    if (el && displayType === 'flex') el.classList.add('flex');
  }
  
  function hideElement(id) {
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden');
    if (el) el.classList.remove('flex');
  }
</script>

</body>
</html>
